---
name: requirements-parser
description: "飞书需求文档自动解析工具。读取飞书文档，提取故事和需求明细，自动添加到多维表格的故事看板和任务看板。"
trigger: 当用户提供飞书文档链接并要求分析需求、拆分故事、创建任务时触发。
---

# 需求分析技能

## 技能目标

自动读取飞书需求文档，智能识别故事（Story）和需求明细，将故事添加到故事看板，将需求明细作为任务添加到任务看板。

## 前置条件

1. 已配置环境变量文件 `.env`
2. 有访问目标飞书文档和多维表格的权限
3. 飞书插件已正确配置并可用

> 💡 **配置说明：** 详细配置步骤请查看 `README.md`

## 工作流程

### 1. 加载配置

从 `.env` 文件读取配置：
- `REQUIREMENTS_STORY_URL`：故事看板完整链接（必填）
- `REQUIREMENTS_TASK_URL`：任务看板完整链接（必填）
- `REQUIREMENTS_DEFAULT_PM_ID`：默认产品负责人 ID（可选）
- `REQUIREMENTS_DEFAULT_DEV_ID`：默认开发负责人 ID（可选）
- `REQUIREMENTS_DEFAULT_VERSION`：默认影响版本（可选）

**验证：** 检查必填项是否完整，缺失时提示用户配置。

**解析链接：** 从完整 URL 中提取 `app_token` 和 `table_id`

### 2. 读取需求文档

根据用户提供的飞书文档链接，提取 `doc_token`。

使用 `feishu_doc` 工具读取文档内容。

**文档格式识别：**
- 支持表格形式的故事清单（列名：序号、故事、日期、产品经理）
- 支持标题形式的故事组织
- 自动识别故事标题和对应的需求详情

### 3. 提取故事和需求

**提取策略：**

从文档中识别以下信息：
- **故事名称**：通常在表格的"故事"列或作为标题
- **产品负责人**：从"产品经理"列提取
- **需求详情**：每个故事下的具体需求点

**需求分类：**
每个故事可能包含多个需求点，每个需求点将作为一个独立的任务。

**需求识别模式：**
- 需求点通常以列表形式呈现
- 包含需求标题和详细说明
- 可能包含：背景、目的、实现方式等

### 4. 查看故事看板结构

使用 `feishu_bitable_list_fields` 查看故事看板的字段结构。

**常见字段：**
- 故事名称（主键，Text）
- 故事描述（Text）
- 产品负责人（User）
- 故事负责人（User）
- 开发完成时间（DateTime）
- 状态（SingleSelect）
- 影响版本（SingleSelect）
- 备注（SingleSelect）

### 5. 检查故事是否已存在

使用 `feishu_bitable_list_records` 获取故事看板中的所有记录。

**存在性判断：**
- 通过故事名称匹配
- 如果故事已存在，跳过创建，避免重复

### 6. 创建故事（如需要）

对于不存在的故事，使用 `feishu_bitable_create_record` 创建。

**字段填充规则：**
- **故事名称**：从文档提取
- **故事描述**：使用文档标题或版本信息
- **产品负责人**：从文档提取（支持名称匹配）
- **状态**：默认"未开始"
- **影响版本**：使用配置的默认版本

### 7. 查看任务看板结构

使用 `feishu_bitable_list_fields` 查看任务看板的字段结构。

**常见字段：**
- 任务名称（主键，Text）
- 开发备注（Text）
- 工时（Number）
- 关联故事（SingleLink，关联到故事看板）
- 状态（SingleSelect）
- 开发人员（User）
- 影响版本（Lookup，从故事看板查找）
- 联调备注（Text）

### 8. 创建任务记录

对于每个需求点，创建一个任务记录。

**任务命名规范：**
- 格式：`{故事名}-{需求点简述}`
- 示例：`种草计提-筛选计划限制调整`

**字段填充规则：**
- **任务名称**：需求点的标题或简述
- **开发备注**：需求点的详细说明
- **状态**：默认"未开始"
- **关联故事**：关联到对应的故事记录（通过 record_id）

### 9. 输出结果

汇报处理摘要：
- 读取的文档标题
- 识别的故事数量
- 已存在的故事数量
- 新创建的故事数量
- 创建的任务数量
- 任务清单（按故事分组）

## 技术要点

### 文档解析策略

- **表格识别**：通过 `Table` block 类型识别
- **字段提取**：通过表头行识别列名
- **内容提取**：遍历数据行提取信息

### 故事-需求映射

- **一对一**：一个故事对应一个需求点
- **一对多**：一个故事包含多个需求点（最常见）
- **识别依据**：需求点通常在同一故事标题下的不同段落或列表项

### 名称匹配

产品负责人和开发负责者的名称匹配：
- 支持中文姓名匹配
- 如果无法匹配到具体用户，使用配置的默认值
- 如果也没有配置默认值，该字段留空

### 错误处理

- **文档无法访问**：提示检查权限或链接是否正确
- **字段结构变化**：提示查看最新字段结构
- **创建失败**：记录失败的项目，继续处理其他项目
- **关联失败**：任务创建成功但关联故事失败，提示手动关联

## 使用示例

用户提供飞书文档链接后，技能自动：
1. 读取配置文件
2. 解析文档内容
3. 提取故事和需求
4. 更新故事看板（避免重复）
5. 创建任务记录
6. 汇报处理结果

**示例输出：**

✅ 需求文档解析完成

📄 文档：KOL V7.0.0版本需求

📊 处理结果：
	识别故事：6 个
	已存在故事：6 个（跳过创建）
	新创建任务：16 个

📋 任务清单：
1. 机器人链接提取优化
   ✅ 优化分发链接的系统识别与自动上传

2. 种草计提自动化优化
   ✅ 筛选计划-计划限制调整
   ✅ 计划数据调整-待执行超级验收支持传SAP
   ✅ 状态付款条件调整

...（后续省略）

## 消息输出策略

**只发送2条消息：确认 + 汇总**

### 执行顺序

1. **第一步：立即发送确认消息**
   - 内容：`"收到，开始分析需求文档..."`
   - 在任何工具调用之前完成

2. **第二步：执行任务**
   - 读取配置
   - 解析文档
   - 创建记录
   - **静默执行，不发送任何中间消息**

3. **第三步：发送汇总消息**
   - 汇报处理结果
   - 列出创建的任务清单
   - **仅此1条汇总消息**

### 消息内容规范

**确认消息（第1条）：**
- 固定内容：`收到，开始分析需求文档...`

**汇总消息（第2条）：**
- 格式化输出处理结果
- 按故事分组展示任务
- 清晰明了的统计信息

**绝对禁止：**
- ❌ 任何中间状态消息
- ❌ 任何错误提示消息
- ❌ 任何进度更新消息

## 配置示例

**步骤 1：创建配置文件**
```bash
cd C:\Users\jueshi\.claude\skills\requirements-parser
cp .env.example .env
```

**步骤 2：填写配置**
编辑 `.env` 文件，填写实际值：
- 从多维表格 URL 提取 `app_token`
- 从故事看板 URL 提取 `table_id`
- 从任务看板 URL 提取 `table_id`

**URL 格式示例：**
```
故事看板：https://syounggroup.feishu.cn/base/ZWDwbEspya3xQ9stBo6cqIW3n4e?table=tblCn5HjmcZEDfgX
任务看板：https://syounggroup.feishu.cn/base/ZWDwbEspya3xQ9stBo6cqIW3n4e?table=tbl8nb16fng5DQdJ
```

提取结果：
```
REQUIREMENTS_APP_TOKEN=ZWDwbEspya3xQ9stBo6cqIW3n4e
REQUIREMENTS_STORY_TABLE_ID=tblCn5HjmcZEDfgX
REQUIREMENTS_TASK_TABLE_ID=tbl8nb16fng5DQdJ
```

## 注意事项

1. 文档格式需要相对规范，建议使用模板
2. 产品负责人名称需要与飞书用户名称一致
3. 任务会自动关联到对应的故事（通过 record_id）
4. 如果故事已存在，不会重复创建
5. 建议定期检查任务看板，补充工时和开发人员
